name: Build and Publish

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Prepare Artifacts
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path artifacts
        
        # Copy VST3
        $vstPath = "build/Neon37_artefacts/Release/VST3/Neon37.vst3"
        if (Test-Path $vstPath) {
            Copy-Item -Path $vstPath -Destination "artifacts/" -Recurse
        } else {
            Write-Host "Warning: VST3 not found at $vstPath"
        }
        
        # Copy Standalone EXE
        $exePath = "build/Neon37_artefacts/Release/Standalone/Neon37.exe"
        if (Test-Path $exePath) {
            Copy-Item -Path $exePath -Destination "artifacts/"
        } else {
            Write-Host "Warning: Standalone EXE not found at $exePath"
        }

    - name: Zip Artifacts
      shell: pwsh
      run: |
        Compress-Archive -Path artifacts/* -DestinationPath Neon37_Windows.zip

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Neon37_Windows
        path: Neon37_Windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3

    - name: Configure CMake
      run: cmake -B build -G Xcode -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"

    - name: Build
      run: cmake --build build --config Release

    - name: Prepare Artifacts
      run: |
        mkdir -p artifacts
        
        # Copy VST3
        if [ -d "build/Neon37_artefacts/Release/VST3/Neon37.vst3" ]; then
            cp -R "build/Neon37_artefacts/Release/VST3/Neon37.vst3" artifacts/
        else
            echo "Warning: VST3 not found"
        fi
        
        # Copy Standalone App
        if [ -d "build/Neon37_artefacts/Release/Standalone/Neon37.app" ]; then
            cp -R "build/Neon37_artefacts/Release/Standalone/Neon37.app" artifacts/
        else
            echo "Warning: Standalone App not found"
        fi

    - name: Zip Artifacts
      run: |
        zip -r Neon37_MacOS.zip artifacts

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Neon37_MacOS
        path: Neon37_MacOS.zip
